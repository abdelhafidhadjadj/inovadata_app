# Contexte du Projet DataMine

Je d√©veloppe une plateforme compl√®te de data mining et machine learning avec architecture microservices.

## Stack Technique
- **Frontend**: SvelteKit + TypeScript + Tailwind CSS
- **Backend**: FastAPI (Python) - service `data-processing` sur port 8001
- **Database**: PostgreSQL
- **Containerisation**: Docker + Docker Compose
- **Volumes**: `/app/uploads` pour les fichiers, `/app/models` pour les mod√®les ML

## Architecture Actuelle

### Services Docker
```yaml
services:
  postgres:
    image: postgres:15
    ports: ["5432:5432"]
  
  frontend:
    build: ./frontend
    ports: ["3000:3000"]
  
  data-processing:
    build: ./data-processing
    ports: ["8001:8001"]
    volumes:
      - ./data-processing:/app
      - uploads:/app/uploads
      - models:/app/models
```

### Structure Backend (FastAPI)
```
data-processing/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                    # Routes principales
‚îÇ   ‚îú‚îÄ‚îÄ models.py                  # Mod√®les Pydantic
‚îÇ   ‚îú‚îÄ‚îÄ processors/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ csv_processor.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ json_processor.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ arff_processor.py
‚îÇ   ‚îî‚îÄ‚îÄ preprocessing/
‚îÇ       ‚îî‚îÄ‚îÄ transformers.py        # DataTransformer class
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ Dockerfile
```

### Base de Donn√©es PostgreSQL

**Tables existantes** :
```sql
CREATE USER IF NOT EXISTS postgres WITH PASSWORD 'postgres' CREATEDB;

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(255),
    avatar_url VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    is_active BOOLEAN DEFAULT TRUE,
    is_admin BOOLEAN DEFAULT FALSE
);

-- Table Sessions (sessions en base, pas Redis)
CREATE TABLE sessions (
    id VARCHAR(255) PRIMARY KEY,
    user_id INT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    data JSONB,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Table Projects
CREATE TABLE projects (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    owner_id INT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    status VARCHAR(50) DEFAULT 'active',
    metadata JSONB
);

-- Table Project Members (collaboration)
CREATE TABLE project_members (
    id SERIAL PRIMARY KEY,
    project_id INT NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    user_id INT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(50) DEFAULT 'viewer', -- owner, editor, viewer
    added_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(project_id, user_id)
);

-- Table Datasets
CREATE TABLE datasets (
    id SERIAL PRIMARY KEY,
    project_id INT NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    filename VARCHAR(255),
    file_path VARCHAR(500),
    file_format VARCHAR(20), -- csv, json, arff
    file_size FLOAT,
    upload_date TIMESTAMP DEFAULT NOW(),
    rows_count INT,
    columns_count INT,
    columns_info JSONB DEFAULT '[]'::jsonb,
    memory_usage FLOAT,
    processing_status VARCHAR(50) DEFAULT 'pending',
    processing_error TEXT,
    metadata JSONB,
    preprocessing_history JSONB,
    current_state JSONB,
    processed_at TIMESTAMP,
    created_by INT NOT NULL REFERENCES users(id),
    UNIQUE(project_id, name),
    updated_at TIMESTAMP DEFAULT NOW(),
);

-- Table Dataset Versions
CREATE TABLE dataset_versions (
    id SERIAL PRIMARY KEY,
    dataset_id INT NOT NULL REFERENCES datasets(id) ON DELETE CASCADE,
    version_number INT,
    description VARCHAR(255),
    preprocessing_steps JSONB,
    is_active BOOLEAN DEFAULT TRUE,
    transformations JSONB,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    created_by INT NOT NULL REFERENCES users(id)
);

-- Table Experiments (entra√Ænement ML)
CREATE TABLE experiments (
    id SERIAL PRIMARY KEY,
    project_id INT NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    dataset_id INT NOT NULL REFERENCES datasets(id) ON DELETE CASCADE,
    name VARCHAR(255),
    model_type VARCHAR(50), -- classification, regression
    algorithm VARCHAR(100), -- KNN, NaiveBayes, DecisionTree, etc.
    hyperparameters JSONB,
    training_config JSONB,
    status VARCHAR(50) DEFAULT 'pending', -- pending, running, completed, failed
    progress INT DEFAULT 0,
    training_time_seconds FLOAT,
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    created_by INT NOT NULL REFERENCES users(id)
);

-- Table Experiment Results
CREATE TABLE experiment_results (
    id SERIAL PRIMARY KEY,
    experiment_id INT NOT NULL REFERENCES experiments(id) ON DELETE CASCADE,
    metrics JSONB,
    confusion_matrix JSONB,
    feature_importance JSONB,
    train_metrics JSONB,
    test_metrics JSONB,
    validation_metrics JSONB,
    model_artifact_path VARCHAR(500),
    created_at TIMESTAMP DEFAULT NOW()
);

-- Table Visualizations
CREATE TABLE visualizations (
    id SERIAL PRIMARY KEY,
    dataset_id INT NOT NULL REFERENCES datasets(id) ON DELETE CASCADE,
    name VARCHAR(255),
    chart_type VARCHAR(50),
    chart_config JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    created_by INT NOT NULL REFERENCES users(id)
);

-- Table Activity Logs
CREATE TABLE activity_logs (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL REFERENCES users(id),
    project_id INT REFERENCES projects(id),
    action VARCHAR(100),
    resource_type VARCHAR(50),
    resource_id INT,
    details JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Indices
CREATE INDEX idx_projects_owner ON projects(owner_id);
CREATE INDEX idx_datasets_project ON datasets(project_id);
CREATE INDEX idx_experiments_project ON experiments(project_id);
CREATE INDEX idx_sessions_user ON sessions(user_id);
CREATE INDEX idx_sessions_expires ON sessions(expires_at);

```

## ‚úÖ Fonctionnalit√©s D√©j√† Impl√©ment√©es

### 1. Gestion de Projets & Datasets
- ‚úÖ Authentification utilisateurs
- ‚úÖ CRUD projets
- ‚úÖ Upload datasets (CSV, JSON, ARFF)
- ‚úÖ Analyse automatique des colonnes (types, stats, distributions)
- ‚úÖ Preview des donn√©es

### 2. Preprocessing Complet

**Valeurs Manquantes** :
- ‚úÖ D√©tection (standard + custom : "!!", "?", etc.)
- ‚úÖ Fill (mean, median, mode, min, max)
- ‚úÖ Forward fill
- ‚úÖ Remove rows

**Outliers** :
- ‚úÖ D√©tection (IQR, Z-score, Range personnalis√©)
- ‚úÖ Replace avec statistiques
- ‚úÖ Remove rows

**Transformations** :
- ‚úÖ Normalisation (Min-Max, Z-score, Robust Scaler)
- ‚úÖ Encodage (Label Encoding, One-Hot Encoding)

### 3. Versioning
- ‚úÖ Versioning automatique des datasets apr√®s chaque transformation
- ‚úÖ Historique des transformations (JSONB)
- ‚úÖ Restauration de versions pr√©c√©dentes

### 4. Visualisations
- ‚úÖ Box plots pour d√©tection outliers
- ‚úÖ Histogrammes de distribution
- ‚úÖ Scatter plots multivari√©s
- ‚úÖ Tables d'outliers

## üéØ OBJECTIF : Module ML Training & Experiments

### Fonctionnalit√©s Requises

#### 1Ô∏è‚É£ Train/Test Split
- Configuration du ratio (60/40, 70/30, 80/20, custom)
- Stratified split pour classification (pr√©server les proportions de classes)
- Random seed pour reproductibilit√©
- Cross-validation K-fold (3, 5, 10 folds)
- Sauvegarde des indices de split pour r√©utilisation

#### 2Ô∏è‚É£ Algorithmes ML √† Impl√©menter

**Classification** (PRIORIT√â) :
1. **K-Nearest Neighbors (KNN)**
   - Hyperparam√®tres : n_neighbors (1-20), weights ('uniform', 'distance'), metric ('euclidean', 'manhattan')
   
2. **Naive Bayes**
   - Gaussian Naive Bayes (pour features continues)
   - Multinomial Naive Bayes (pour features discr√®tes/comptages)
   - Bernoulli Naive Bayes (pour features binaires)
   
3. **Decision Trees**
   - **C4.5 / J48** : Utiliser DecisionTreeClassifier de sklearn avec criterion='entropy'
   - **CHAID** : Si possible, utiliser une lib comme `CHAID` ou impl√©menter une version simplifi√©e
   - Hyperparam√®tres : max_depth, min_samples_split, min_samples_leaf
   
4. **Neural Networks (MLP)**
   - MLPClassifier de sklearn
   - Hyperparam√®tres : hidden_layer_sizes, activation ('relu', 'tanh', 'logistic'), learning_rate, max_iter

**R√©gression** (OPTIONNEL, Phase 2) :
- Linear Regression
- Polynomial Regression  
- Random Forest Regressor

#### 3Ô∏è‚É£ Configuration des Exp√©riences

**Interface de cr√©ation** :
- S√©lection du dataset (avec version)
- Choix de la target column (variable √† pr√©dire)
- S√©lection des features (variables explicatives)
- Choix de l'algorithme
- Configuration des hyperparam√®tres (formulaire dynamique selon l'algo)
- Configuration du train/test split

#### 4Ô∏è‚É£ Entra√Ænement

**Processus** :
- Validation des donn√©es (pas de valeurs manquantes, types corrects)
- Split train/test selon configuration
- Entra√Ænement du mod√®le
- Tracking du temps d'entra√Ænement
- Logs des √©tapes
- Gestion des erreurs

**Ex√©cution asynchrone** (bonus) :
- Queue de jobs pour exp√©riences longues
- Status tracking ('pending', 'training', 'completed', 'failed')
- Progress bar si possible

#### 5Ô∏è‚É£ √âvaluation & M√©triques

**Classification** :
- Accuracy (taux de bonnes pr√©dictions)
- Precision, Recall, F1-Score (par classe et macro/micro average)
- Confusion Matrix (visualisation heatmap)
- ROC Curve & AUC (pour classification binaire)
- Classification Report complet

**R√©gression** (si impl√©ment√©) :
- MSE (Mean Squared Error)
- RMSE (Root Mean Squared Error)
- R¬≤ Score (coefficient de d√©termination)
- MAE (Mean Absolute Error)

#### 6Ô∏è‚É£ Sauvegarde & Persistence

**Mod√®les** :
- Sauvegarder avec `joblib` ou `pickle`
- Nommage : `model_{experiment_id}_{timestamp}.pkl`
- Stockage : `/app/models/project_{id}/`

**M√©tadonn√©es** :
- Tous les param√®tres utilis√©s
- M√©triques obtenues
- Date/heure d'entra√Ænement
- Features utilis√©es
- Preprocessing appliqu√©

#### 7Ô∏è‚É£ Comparaison de Mod√®les

**Interface** :
- Tableau comparatif des exp√©riences
- Tri par m√©trique (accuracy, F1, etc.)
- Filtres par algorithme, dataset, date
- Visualisations comparatives (bar charts des m√©triques)
- Export des r√©sultats (CSV, PDF)

#### 8Ô∏è‚É£ Pr√©dictions (Bonus)

**Utilisation d'un mod√®le entra√Æn√©** :
- Upload de nouvelles donn√©es
- Application du m√™me preprocessing
- Pr√©dictions avec le mod√®le sauvegard√©
- Export des r√©sultats

---

## üìã Sch√©ma de Base de Donn√©es √† Cr√©er
```sql
CREATE TABLE ml_experiments (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  dataset_id INT REFERENCES datasets(id) ON DELETE CASCADE,
  dataset_version_id INT REFERENCES dataset_versions(id),
  
  -- Configuration
  algorithm VARCHAR(50) NOT NULL, -- 'knn', 'naive_bayes', 'decision_tree_c45', 'decision_tree_chaid', 'neural_network'
  hyperparameters JSONB NOT NULL, -- Params sp√©cifiques √† l'algo
  target_column VARCHAR(100) NOT NULL,
  feature_columns JSONB NOT NULL, -- Liste des features
  
  -- Split configuration
  train_ratio FLOAT DEFAULT 0.8,
  test_ratio FLOAT DEFAULT 0.2,
  random_seed INT DEFAULT 42,
  stratified BOOLEAN DEFAULT TRUE,
  cv_folds INT, -- NULL si pas de cross-validation
  
  -- R√©sultats
  metrics JSONB, -- Toutes les m√©triques (accuracy, precision, recall, etc.)
  confusion_matrix JSONB,
  training_time FLOAT, -- en secondes
  
  -- Fichiers
  model_path VARCHAR(500), -- Chemin vers le mod√®le .pkl
  
  -- Tracking
  status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'training', 'completed', 'failed'
  error_message TEXT,
  
  -- Audit
  created_by INT REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  started_at TIMESTAMP,
  completed_at TIMESTAMP
);

-- Index pour performance
CREATE INDEX idx_ml_experiments_dataset ON ml_experiments(dataset_id);
CREATE INDEX idx_ml_experiments_status ON ml_experiments(status);
CREATE INDEX idx_ml_experiments_algorithm ON ml_experiments(algorithm);
CREATE INDEX idx_ml_experiments_created_by ON ml_experiments(created_by);

-- Table pour les pr√©dictions (bonus)
CREATE TABLE ml_predictions (
  id SERIAL PRIMARY KEY,
  experiment_id INT REFERENCES ml_experiments(id) ON DELETE CASCADE,
  input_data JSONB NOT NULL,
  prediction JSONB NOT NULL, -- Classe pr√©dite + probabilit√©s
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## üèóÔ∏è Architecture Backend Propos√©e

### Structure des Fichiers
```
data-processing/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îú‚îÄ‚îÄ ml/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py              # Mod√®les Pydantic pour ML
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ trainer.py             # Classe principale d'entra√Ænement
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ algorithms/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knn.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ naive_bayes.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ decision_tree.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ neural_network.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ evaluator.py           # Calcul des m√©triques
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.py               # Fonctions utilitaires
‚îÇ   ‚îî‚îÄ‚îÄ ...
```

### Endpoints FastAPI √† Cr√©er
```python
# Routes ML
@app.post("/ml/experiments/create")
@app.post("/ml/experiments/{id}/train")
@app.get("/ml/experiments/{id}")
@app.get("/ml/experiments/list")
@app.delete("/ml/experiments/{id}")
@app.post("/ml/experiments/{id}/evaluate")
@app.post("/ml/experiments/compare")
@app.get("/ml/experiments/{id}/download-model")
@app.post("/ml/experiments/{id}/predict")

# Utilitaires
@app.post("/ml/validate-features")  # Valider que les features sont OK
@app.get("/ml/algorithms")          # Liste des algos disponibles
@app.get("/ml/algorithms/{name}/params")  # Params d'un algo
```

### Mod√®les Pydantic
```python
class ExperimentCreate(BaseModel):
    name: str
    description: Optional[str]
    dataset_id: int
    dataset_version_id: Optional[int]
    algorithm: str  # 'knn', 'naive_bayes', etc.
    hyperparameters: dict
    target_column: str
    feature_columns: List[str]
    train_ratio: float = 0.8
    random_seed: int = 42
    stratified: bool = True
    cv_folds: Optional[int] = None

class ExperimentResponse(BaseModel):
    id: int
    name: str
    algorithm: str
    status: str
    metrics: Optional[dict]
    created_at: datetime
    # ...
```

---

## üé® Frontend SvelteKit

### Routes √† Cr√©er
```
/dashboard/projects/[id]/datasets/[datasetId]/ml/
‚îú‚îÄ‚îÄ experiments/                    # Liste des exp√©riences
‚îú‚îÄ‚îÄ experiments/create/             # Cr√©er nouvelle exp√©rience
‚îú‚îÄ‚îÄ experiments/[experimentId]/     # D√©tails & r√©sultats
‚îî‚îÄ‚îÄ experiments/compare/            # Comparer plusieurs mod√®les
```

### Composants √† Cr√©er
```
src/lib/components/ml/
‚îú‚îÄ‚îÄ AlgorithmSelector.svelte
‚îú‚îÄ‚îÄ FeatureSelector.svelte
‚îú‚îÄ‚îÄ HyperparameterForm.svelte      # Formulaire dynamique
‚îú‚îÄ‚îÄ TrainTestSplitConfig.svelte
‚îú‚îÄ‚îÄ MetricsDisplay.svelte
‚îú‚îÄ‚îÄ ConfusionMatrixHeatmap.svelte
‚îú‚îÄ‚îÄ ROCCurve.svelte
‚îú‚îÄ‚îÄ ExperimentsList.svelte
‚îî‚îÄ‚îÄ ModelsComparison.svelte
```

---

## üì¶ D√©pendances Python √† Ajouter
```txt
# requirements.txt (ajouter)
scikit-learn==1.3.2
joblib==1.3.2
matplotlib==3.8.2
seaborn==0.13.0
numpy==1.26.2
scipy==1.11.4

# Pour CHAID (optionnel)
CHAID==5.4.1
```

---

## üöÄ Plan d'Impl√©mentation Recommand√©

### Phase 1 : Infrastructure (1-2h)
1. Cr√©er la table `ml_experiments`
2. Cr√©er la structure de fichiers backend (`app/ml/`)
3. Cr√©er les mod√®les Pydantic de base
4. Cr√©er les routes principales (vides)

### Phase 2 : KNN & Decision Tree (2-3h)
5. Impl√©menter `algorithms/knn.py`
6. Impl√©menter `algorithms/decision_tree.py` (C4.5)
7. Cr√©er `trainer.py` avec m√©thode `train()`
8. Cr√©er `evaluator.py` pour m√©triques de base
9. Endpoint `/ml/experiments/create` + `/ml/experiments/{id}/train`

### Phase 3 : Frontend Basique (2h)
10. Page cr√©ation d'exp√©rience
11. S√©lecteur de features
12. Configuration split train/test
13. Affichage des r√©sultats (m√©triques basiques)

### Phase 4 : Autres Algorithmes (2-3h)
14. Naive Bayes
15. Neural Network
16. CHAID (si temps)

### Phase 5 : Visualisations (1-2h)
17. Confusion Matrix heatmap
18. M√©triques comparatives
19. ROC curves (si temps)

### Phase 6 : Features Avanc√©es (optionnel)
20. Cross-validation
21. Hyperparameter tuning (Grid Search)
22. Export de rapports PDF

---

## ‚ùì Question Initiale

**Commencez par me proposer :**

1. **L'impl√©mentation compl√®te de `trainer.py`** avec la classe `MLTrainer` qui g√®re :
   - Chargement du dataset
   - Validation des features/target
   - Train/test split
   - Entra√Ænement du mod√®le
   - Sauvegarde du mod√®le
   - Calcul des m√©triques

2. **L'impl√©mentation de `algorithms/knn.py`** comme premier algorithme

3. **Les endpoints FastAPI** pour cr√©er et entra√Æner une exp√©rience

4. **Le sch√©ma SQL** final avec tous les d√©tails

Je veux du code **production-ready**, bien structur√©, avec gestion d'erreurs, logging et commentaires explicatifs.

Allons-y √©tape par √©tape ! üöÄ